{% extends "base.html" %}
{% block title %}Edit Event - Community Contribution Tracking{% endblock %}
{% block content %}
<h2 class="mb-4"><i class="bi bi-pencil"></i> Edit: {{ event.event_name }}</h2>

<ul class="nav nav-tabs mb-3" id="eventTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#basicInfo">Basic Info</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#contributions">Contributions ({{ contributions|length }})</a></li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade show active" id="basicInfo">
        <form method="POST">
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">Event Info</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Event Name *</label>
                                <input type="text" name="event_name" class="form-control" value="{{ event.event_name }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Event Date *</label>
                                <input type="date" name="event_date" class="form-control" value="{{ event.event_date }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Event Type</label>
                                <select name="event_type_id" class="form-select">
                                    <option value="">-- Select --</option>
                                    {% for t in event_types %}<option value="{{ t.id }}" {{ 'selected' if event.event_type_id == t.id }}>{{ t.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-control" value="{{ event.location or '' }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="2">{{ event.description or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">Organization & Coordinator</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Organization</label>
                                <select name="organization_id" class="form-select">
                                    <option value="">-- Select --</option>
                                    {% for o in organizations %}<option value="{{ o.id }}" {{ 'selected' if event.organization_id == o.id }}>{{ o.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Coordinator Name</label>
                                <input type="text" name="coordinator_name" class="form-control" value="{{ event.coordinator_name or '' }}">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" name="coordinator_phone" class="form-control" value="{{ event.coordinator_phone or '' }}">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="coordinator_email" class="form-control" value="{{ event.coordinator_email or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">Activity Data</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Expected</label>
                                    <input type="number" name="expected_participants" class="form-control" value="{{ event.expected_participants }}">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Actual</label>
                                    <input type="number" name="actual_participants" class="form-control" value="{{ event.actual_participants }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Income ($)</label>
                                    <input type="number" name="income" class="form-control" step="0.01" value="{{ event.income }}">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Expense ($)</label>
                                    <input type="number" name="expense" class="form-control" step="0.01" value="{{ event.expense }}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="In Progress" {{ 'selected' if event.status == 'In Progress' }}>In Progress</option>
                                    <option value="Completed" {{ 'selected' if event.status == 'Completed' }}>Completed</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="2">{{ event.notes or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Changes</button>
            <a href="{{ url_for('event_list') }}" class="btn btn-outline-secondary">Back to List</a>
        </form>
    </div>
    
    <div class="tab-pane fade" id="contributions">
        <div class="card mb-3">
            <div class="card-header bg-success text-white"><i class="bi bi-plus-circle"></i> Add Contribution</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_contribution', event_id=event.id) }}" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Volunteer *</label>
                        <select name="volunteer_id" class="form-select" id="volunteerSelect">
                            <option value="">-- New --</option>
                            {% for v in volunteers %}<option value="{{ v.id }}">{{ v.name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Name *</label>
                        <input type="text" name="volunteer_name" class="form-control" id="volunteerName" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Contact</label>
                        <input type="text" name="volunteer_contact" class="form-control" placeholder="Phone/Email">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Hours</label>
                        <input type="number" name="volunteer_hours" class="form-control" step="0.5" min="0" value="0">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Cash ($)</label>
                        <input type="number" name="cash_donation" class="form-control" step="0.01" min="0" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Material Desc</label>
                        <input type="text" name="material_description" class="form-control">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Value ($)</label>
                        <input type="number" name="material_value" class="form-control" step="0.01" min="0" value="0">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100"><i class="bi bi-plus"></i></button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Contribution Records</div>
            <div class="card-body">
                {% if contributions %}
                <table class="table">
                    <thead><tr><th>Volunteer</th><th>Contact</th><th>Hours</th><th>Cash</th><th>Material</th><th>Value</th><th></th></tr></thead>
                    <tbody>
                        {% for c in contributions %}
                        <tr>
                            <td>{{ c.volunteer_name }}</td>
                            <td>{{ c.volunteer_contact or '-' }}</td>
                            <td>{{ c.volunteer_hours }} hrs</td>
                            <td>${{ "%.2f"|format(c.cash_donation) }}</td>
                            <td>{{ c.material_description or '-' }}</td>
                            <td>${{ "%.2f"|format(c.material_value) }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_contribution', contribution_id=c.id) }}" class="d-inline" onsubmit="return confirm('Delete?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p class="text-muted">No contributions yet</p>{% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('volunteerSelect').addEventListener('change', function() {
    var selected = this.options[this.selectedIndex];
    if (selected.value) {
        document.getElementById('volunteerName').value = selected.text;
    } else {
        document.getElementById('volunteerName').value = '';
    }
});
</script>
{% endblock %}
